# M3T 追踪参数调优指南

## 概述

如果追踪效果不好，可以通过调整以下参数来改善。参数调整需要根据具体问题（模型漂移、旋转不准确、大小变化等）来选择。

---

## 1. Optimizer（优化器）参数

**位置**：`run_realsense_tracking.cpp` 第 207-212 行

### `tikhonov_parameter_translation`（平移正则化）
- **当前值**：15000.0f
- **作用**：控制平移变化的平滑度
- **调优建议**：
  - **模型漂移严重**：增大（30000.0f - 50000.0f）
  - **模型跟不上移动**：减小（10000.0f - 15000.0f）
  - **Z轴变化过大**：增大（30000.0f - 100000.0f）

### `tikhonov_parameter_rotation`（旋转正则化）
- **当前值**：300.0f
- **作用**：控制旋转变化的平滑度
- **调优建议**：
  - **旋转不稳定**：增大（500.0f - 1000.0f）
  - **旋转跟不上**：减小（200.0f - 300.0f）
  - **旋转完全不动**：大幅减小（100.0f - 200.0f）

---

## 2. Tracker（追踪器）参数

**位置**：`run_realsense_tracking.cpp` 第 224-226 行

### `n_corr_iterations`（对应点迭代次数）
- **当前值**：7
- **作用**：每次追踪循环中计算对应点的迭代次数
- **调优建议**：
  - **追踪不准确**：增加（8 - 10）
  - **追踪太慢**：减少（5 - 6）
  - **追踪不稳定**：减少（5 - 6）

### `n_update_iterations`（更新迭代次数）
- **当前值**：2
- **作用**：每次对应点迭代中的优化更新次数
- **调优建议**：
  - **追踪不准确**：增加（3 - 4）
  - **追踪太慢**：保持（2）
  - **追踪不稳定**：减少（1）

---

## 3. RegionModality（区域模态）参数

**位置**：`run_realsense_tracking.cpp` 第 106-127 行

### `learning_rate`（学习率）
- **当前值**：1.3f（RBOT标准值）
- **作用**：控制颜色直方图更新的速度
- **调优建议**：
  - **光照变化大**：增大（1.5f - 2.0f）
  - **背景干扰多**：减小（1.0f - 1.2f）
  - **追踪不稳定**：减小（1.0f - 1.2f）

### `scales`（尺度）
- **当前值**：{5, 2, 2, 1}（RBOT标准值）
- **作用**：多尺度追踪的尺度级别
- **调优建议**：
  - **追踪不准确**：增加更多尺度（{6, 3, 2, 1}）
  - **追踪太慢**：减少尺度（{4, 2, 1}）
  - **小物体**：使用更小的初始尺度（{3, 2, 1}）

### `standard_deviations`（标准差）
- **当前值**：{20.0f, 7.0f, 3.0f, 1.5f}（RBOT标准值）
- **作用**：控制每个尺度级别的敏感度
- **调优建议**：
  - **追踪不稳定**：增大（{25.0f, 10.0f, 5.0f, 2.0f}）
  - **追踪不准确**：减小（{18.0f, 6.0f, 2.5f, 1.2f}）
  - **噪声大**：增大（{30.0f, 15.0f, 8.0f, 3.0f}）

### `n_histogram_bins`（直方图bin数）
- **当前值**：32
- **作用**：颜色直方图的分辨率
- **调优建议**：
  - **颜色丰富**：增加（64）
  - **颜色单一**：减少（16 - 24）
  - **一般情况**：保持（32）

---

## 4. DepthModality（深度模态）参数

**位置**：`run_realsense_tracking.cpp` 第 182-199 行

### `n_points_max`（最大点数）
- **当前值**：200
- **作用**：使用的最大深度点数
- **调优建议**：
  - **追踪不准确**：增加（300 - 500）
  - **追踪太慢**：减少（100 - 150）
  - **深度噪声大**：减少（100 - 150）

### `stride_length`（步长）
- **当前值**：0.005f（5mm）
- **作用**：深度点采样的步长
- **调优建议**：
  - **小物体**：减小（0.003f - 0.004f）
  - **大物体**：增大（0.007f - 0.01f）
  - **深度噪声大**：增大（0.007f - 0.01f）

### `standard_deviations`（标准差）
- **当前值**：{0.035f, 0.035f, 0.025f}
- **作用**：深度匹配的容差
- **调优建议**：
  - **深度噪声大**：增大（{0.05f, 0.05f, 0.035f}）
  - **追踪不准确**：减小（{0.025f, 0.025f, 0.02f}）
  - **深度精度高**：减小（{0.02f, 0.02f, 0.015f}）

---

## 5. TextureModality（特征点模态）参数

**位置**：`run_realsense_tracking.cpp` 第 147-180 行

### `descriptor_type`（描述符类型）
- **当前值**：ORB
- **作用**：特征点描述符类型
- **调优建议**：
  - **纹理丰富**：使用ORB（当前）
  - **纹理单一**：可以禁用（注释掉 `link_ptr->AddModality(texture_modality_ptr)`）

### `orb_n_features`（ORB特征点数）
- **当前值**：300
- **作用**：提取的ORB特征点数量
- **调优建议**：
  - **追踪不准确**：增加（400 - 500）
  - **追踪太慢**：减少（200 - 250）
  - **纹理少**：减少（200）

### `descriptor_distance_threshold`（描述符距离阈值）
- **当前值**：0.7f
- **作用**：特征点匹配的距离阈值
- **调优建议**：
  - **匹配太多误匹配**：减小（0.5f - 0.6f）
  - **匹配点太少**：增大（0.8f - 0.9f）

---

## 6. Z轴监控参数

**位置**：`run_realsense_tracking.cpp` 第 363-375 行

### `z_limit_range`（Z轴限制范围）
- **当前值**：0.20f（20cm）
- **作用**：允许Z轴偏离初始距离的最大范围
- **调优建议**：
  - **Z轴漂移严重**：减小（0.10f - 0.15f）
  - **需要跟随移动**：增大允许范围，但不要太小
  - **物体移动范围大**：增大（0.25f - 0.30f）

---

## 常见问题及解决方案

### 问题1：模型漂移（模型逐渐偏离物体）
**解决方案**：
1. 增大 `tikhonov_parameter_translation`（30000.0f - 50000.0f）
2. 增大 `tikhonov_parameter_rotation`（500.0f - 1000.0f）
3. 减小 `n_corr_iterations`（5 - 6）
4. 减小 `learning_rate`（1.0f - 1.2f）

### 问题2：模型跟不上移动（滞后）
**解决方案**：
1. 减小 `tikhonov_parameter_translation`（10000.0f - 15000.0f）
2. 减小 `tikhonov_parameter_rotation`（200.0f - 300.0f）
3. 增加 `n_corr_iterations`（8 - 10）
4. 增加 `n_update_iterations`（3 - 4）

### 问题3：旋转不准确
**解决方案**：
1. 减小 `tikhonov_parameter_rotation`（200.0f - 300.0f）
2. 启用 `TextureModality`（如果被禁用）
3. 增加 `orb_n_features`（400 - 500）
4. 增加 `n_corr_iterations`（8 - 10）

### 问题4：模型大小变化（缩放）
**解决方案**：
1. 增大 `tikhonov_parameter_translation`（50000.0f - 100000.0f）
2. 减小 `n_corr_iterations`（5 - 6）
3. 减小 `learning_rate`（1.0f - 1.2f）
4. 减小Z轴限制范围（0.10f - 0.15f）

### 问题5：追踪丢失后无法恢复
**解决方案**：
1. 减小 `tikhonov_parameter_translation`（10000.0f - 15000.0f）
2. 减小 `tikhonov_parameter_rotation`（200.0f - 300.0f）
3. 增加 `n_corr_iterations`（8 - 10）
4. 使用R键手动重新检测

### 问题6：光照变化导致追踪失败
**解决方案**：
1. 增加 `learning_rate`（1.5f - 2.0f）
2. 增加 `n_histogram_bins`（64）
3. 启用 `TextureModality`（特征点对光照变化更鲁棒）

---

## 参数调整流程

1. **确定问题**：模型漂移、旋转不准确、大小变化等
2. **选择相关参数**：根据问题选择对应的参数类别
3. **小步调整**：每次只调整一个参数，调整幅度不要太大（10-20%）
4. **测试效果**：运行程序测试效果
5. **迭代优化**：如果效果改善，继续微调；如果变差，回退并尝试其他参数

---

## 参考值

### RBOT数据集标准值（稳定但可能不够灵活）
- `tikhonov_parameter_translation`: 30000.0f
- `tikhonov_parameter_rotation`: 1000.0f
- `n_corr_iterations`: 7
- `learning_rate`: 1.3f
- `scales`: {5, 2, 2, 1}
- `standard_deviations`: {20.0f, 7.0f, 3.0f, 1.5f}

### 当前使用的值（平衡稳定性和响应性）
- `tikhonov_parameter_translation`: 15000.0f
- `tikhonov_parameter_rotation`: 300.0f
- `n_corr_iterations`: 7
- `learning_rate`: 1.3f
- `scales`: {5, 2, 2, 1}
- `standard_deviations`: {20.0f, 7.0f, 3.0f, 1.5f}

---

## 注意事项

1. **不要同时调整太多参数**：一次只调整1-2个参数
2. **记录调整历史**：记录每次调整的参数和效果
3. **测试环境一致**：在相同的环境和条件下测试
4. **备份原始值**：调整前备份原始参数值
5. **耐心调试**：参数调优需要时间和耐心





