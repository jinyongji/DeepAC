# 使用M3T风格的对齐追踪功能

## 概述

`live_tracking_with_alignment.py` 实现了类似M3T的两阶段追踪流程：

1. **第一阶段（对齐阶段）**：持续显示蓝色模型轮廓，让用户手动对齐魔方
2. **第二阶段（追踪阶段）**：对齐后按SPACE键开始实时追踪

## 使用方法

### 运行程序

```bash
python -m src_open.tools.live_tracking_with_alignment --cfg src_open/configs/live/cube_rgb_demo_style.yaml
```

### 操作步骤

1. **等待初始化**：程序启动后会初始化相机和模型
2. **查看蓝色模型轮廓**：窗口中会显示一个蓝色的模型轮廓（引导框）
3. **对齐魔方**：移动魔方或相机，使魔方与蓝色模型轮廓对齐
4. **开始追踪**：按 **SPACE** 键或 **s** 键开始追踪
5. **追踪阶段**：追踪开始后，绿色框线会跟随魔方移动
6. **退出程序**：按 **ESC** 键或 **q** 键退出

## 与M3T的对比

| 特性 | M3T | DeepAC (新版本) |
|------|-----|-----------------|
| 渲染方式 | OpenGL渲染3D模型 | 绘制轮廓点（wireframe） |
| 对齐阶段 | 显示半透明3D模型 | 显示蓝色轮廓框 |
| 追踪阶段 | 显示追踪结果 | 显示绿色追踪框 |
| 初始化 | 手动对齐后按SPACE | 手动对齐后按SPACE |

## 优势

1. **更好的初始化**：通过手动对齐确保初始位姿正确
2. **更高的成功率**：对齐后再开始追踪，避免初始化位姿不正确的问题
3. **用户友好**：清晰的视觉反馈，蓝色引导框帮助对齐

## 配置

使用与`live_tracking.py`相同的配置文件：

```yaml
# src_open/configs/live/cube_rgb_demo_style.yaml
camera:
  use_realsense_ir: false
  camera_id: 6  # RealSense RGB相机ID
  set_width: 1280
  set_height: 720
  fx: 642.885254  # 会自动从RealSense获取
  fy: 642.059265
  cx: 646.380127
  cy: 369.868805

tracking:
  grayscale: false
  smooth_alpha: 0.5
  bbox_trim_ratio: 0.08
  # ... 其他参数
```

## 故障排除

### 1. 蓝色引导框不显示
- 检查初始位姿是否正确
- 检查相机内参是否正确
- 检查模板视图是否正确加载

### 2. 对齐后追踪失败
- 确保魔方与蓝色引导框完全对齐
- 检查光照条件是否充足
- 尝试调整初始深度（在配置文件中）

### 3. 追踪时绿色框不移动
- 检查直方图区分度（查看终端输出）
- 确保初始化时直方图有足够的区分度
- 尝试使用自动检测功能（按'd'键）

## 技术细节

### 对齐阶段
- 使用`calculate_basic_line_data`计算模型轮廓点
- 使用`draw_overlay`绘制蓝色轮廓框
- 持续更新显示，直到用户按SPACE键

### 追踪阶段
- 使用对齐时的位姿初始化直方图
- 使用`tracking_step_with_preprocess`进行追踪
- 显示绿色追踪框

## 下一步改进

1. 添加深度调整功能（使用键盘上下键调整Z轴）
2. 添加旋转调整功能（使用键盘左右键调整旋转）
3. 添加自动对齐检测（检测对齐质量）
4. 添加对齐质量可视化（显示对齐分数）










