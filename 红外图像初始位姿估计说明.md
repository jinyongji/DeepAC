# 红外图像初始位姿估计说明

## 功能说明

`estimate_ir_initial_pose.py` 脚本用于：
1. 生成 `K.txt` 文件（相机内参矩阵）
2. 自动检测第一帧图像中物体的初始位姿
3. 生成 `initial_projection_check.jpg` 用于验证位姿准确性
4. 保存初始位姿到 `pose.txt` 文件

## 使用方法

### 1. 运行初始位姿估计脚本

```bash
conda run -n deepac python -m src_open.tools.estimate_ir_initial_pose \
    --cfg /home/jyj/Projects/DeepAC/src_open/configs/demo/ir_cube_init.yaml \
    --first_frame /media/jyj/JYJ/cube/frames/IR/frame_00000.jpg \
    --data_dir /media/jyj/JYJ/cube \
    --obj_name cube \
    --init_depth 0.45 \
    --max_detect_views 240
```

### 2. 参数说明

- `--cfg`: 配置文件路径
- `--first_frame`: 第一帧图像路径（默认：`/media/jyj/JYJ/cube/frames/IR/frame_00000.jpg`）
- `--data_dir`: 数据目录（默认：`/media/jyj/JYJ/cube`）
- `--obj_name`: 物体名称（默认：`cube`）
- `--init_depth`: 初始深度估计（米，默认：0.45）
- `--max_detect_views`: 最大检测视图数（默认：240）

### 3. 输出文件

脚本会在以下位置生成文件：

1. **`/media/jyj/JYJ/cube/K.txt`**: 相机内参矩阵（3x3格式）
   ```
   1.19769228e+03  0.00000000e+00  6.35855824e+02
   0.00000000e+00  1.19628881e+03  4.19254040e+02
   0.00000000e+00  0.00000000e+00  1.00000000e+00
   ```

2. **`/media/jyj/JYJ/cube/frames/IR/pose.txt`**: 初始位姿（12个数字一行，3x4矩阵格式）
   - 格式：`[R11 R12 R13 R21 R22 R23 R31 R32 R33 tx ty tz]`
   - 平移单位：毫米（mm）

3. **`/media/jyj/JYJ/cube/frames/IR/initial_projection_check.jpg`**: 初始投影检查图像
   - 红色点：投影的3D模型轮廓点
   - 红色框：检测到的边界框（如果有）

4. **日志目录**: `workspace/demo_ir_cube_init/` 下也会保存一份检查图像

## 4. 验证位姿准确性

运行脚本后，检查 `initial_projection_check.jpg`：
- **红色点应该贴合魔方的边缘**
- 如果红色点偏离较大，可以调整以下参数：
  - `--init_depth`: 调整初始深度估计（如果魔方距离相机较近/远）
  - 修改配置文件中的 `crop_border`、`resize` 等预处理参数

## 5. 后续使用

生成 `K.txt` 和 `pose.txt` 后，可以：
1. 使用 `demo_cube.py` 运行完整的追踪流程
2. 创建红外图像专用的配置文件（参考 `magic_cube.yaml`）

## 注意事项

1. **红外图像格式**: 脚本会自动将单通道灰度图转换为3通道RGB（复制通道）以适配当前模型
2. **位姿单位**: `pose.txt` 中的平移单位是**毫米（mm）**，与RGB数据集保持一致
3. **检测时间**: 检测过程可能需要几分钟，取决于 `max_detect_views` 参数
4. **模型要求**: 需要确保模型文件路径正确，且模型支持当前配置

## 故障排除

### 问题1: 检测失败
- **原因**: 初始深度估计不准确
- **解决**: 调整 `--init_depth` 参数，尝试 0.3、0.4、0.5、0.6 等值

### 问题2: 投影点不准确
- **原因**: 相机内参不准确或图像预处理参数不合适
- **解决**: 
  - 检查 `K.txt` 是否正确
  - 调整配置文件中的 `crop_border`、`resize` 参数

### 问题3: 图像读取失败
- **原因**: 图像路径错误或格式不支持
- **解决**: 检查图像路径和格式（支持 .jpg, .png, .jpeg）





