# 夜间红外实时追踪使用说明

## 概述

本配置用于在夜间环境下使用红外相机进行实时追踪。当相机切换到红外模式时，拍摄的图像是单通道灰度图（红外图像），而不是RGB彩色图像。

## 配置文件

使用配置文件：`src_open/configs/live/cube_ir.yaml`

## 主要特点

1. **灰度图模式**：自动将单通道红外图像转换为RGB格式（复制3次通道）以适配模型
2. **优化的追踪参数**：针对红外图像特性调整了学习率和平滑参数
3. **与RGB模式相同的相机内参**：同一相机在不同模式下的内参相同

## 使用方法

### 基本命令

```bash
conda run -n deepac python -m src_open.tools.live_tracking \
    --cfg /home/jyj/Projects/DeepAC/src_open/configs/live/cube_ir.yaml
```

### 指定摄像头ID

如果默认摄像头ID不正确，可以使用 `--camera_id` 参数：

```bash
conda run -n deepac python -m src_open.tools.live_tracking \
    --cfg /home/jyj/Projects/DeepAC/src_open/configs/live/cube_ir.yaml \
    --camera_id 2
```

### 查找可用摄像头

如果不确定摄像头ID，可以先运行：

```bash
conda run -n deepac python -m src_open.tools.list_cameras
```

## 配置参数说明

### 关键参数

- **`grayscale: true`**: 启用灰度图模式，这是红外模式的关键设置
- **`fore_learn_rate: 0.02`**: 前景直方图学习率（已优化）
- **`back_learn_rate: 0.02`**: 背景直方图学习率（已优化）
- **`template_top_k: 30`**: 使用的模板视图数量（已增加以提高稳定性）
- **`smooth_alpha: 0.3`**: Pose平滑系数（已启用以减少抖动）

### 相机参数

- **`camera_id: 0`**: 摄像头ID（根据实际情况调整）
- **`fx, fy, cx, cy`**: 相机内参（与RGB模式相同）

## 工作原理

1. **图像读取**：摄像头在红外模式下返回单通道灰度图
2. **格式转换**：代码自动将灰度图转换为RGB格式（复制3次通道）
3. **模型处理**：模型接收RGB格式图像进行处理（虽然实际是灰度信息）
4. **追踪输出**：输出追踪结果和可视化

## 与RGB模式的差异

| 特性 | RGB模式 | 红外模式 |
|------|---------|----------|
| 图像类型 | 3通道RGB | 单通道灰度（转换为RGB） |
| 配置文件 | `cube_rgb.yaml` | `cube_ir.yaml` |
| `grayscale` 参数 | `false`（默认） | `true` |
| 适用环境 | 光照充足 | 夜间/低光照 |

## 故障排除

### 问题1: 摄像头无法打开

**解决方案**:
- 运行 `list_cameras.py` 查找可用摄像头
- 使用 `--camera_id` 参数指定正确的摄像头ID

### 问题2: 追踪不稳定

**解决方案**:
- 确保光照条件足够（红外补光正常工作）
- 降低学习率：将`fore_learn_rate`和`back_learn_rate`改为`0.015`
- 增加平滑系数：将`smooth_alpha`改为`0.5`
- 增加模板数量：将`template_top_k`改为`40`

### 问题3: 图像显示异常

**解决方案**:
- 检查摄像头是否正确切换到红外模式
- 确认图像确实是单通道灰度图
- 检查相机内参是否正确

### 问题4: 初始化失败

**解决方案**:
- 确保红外补光正常工作，魔方清晰可见
- 调整`init_depth`参数（默认0.45米）
- 手动按`s`键初始化

## 注意事项

1. **环境要求**：
   - 确保在夜间或低光照环境下测试
   - 确保红外补光正常工作
   - 魔方需要有足够的对比度

2. **性能考虑**：
   - 红外图像质量可能不如RGB图像
   - 可能需要更保守的追踪参数
   - 建议使用pose平滑以减少抖动

3. **相机设置**：
   - 确保相机正确切换到红外模式
   - 检查相机分辨率设置（1280x720）
   - 确认相机内参正确

## 示例命令

### 完整命令（使用摄像头ID 2）

```bash
conda run -n deepac python -m src_open.tools.live_tracking \
    --cfg /home/jyj/Projects/DeepAC/src_open/configs/live/cube_ir.yaml \
    --camera_id 2
```

### 调试模式（查看详细日志）

```bash
conda run -n deepac python -m src_open.tools.live_tracking \
    --cfg /home/jyj/Projects/DeepAC/src_open/configs/live/cube_ir.yaml \
    --camera_id 0
```

## 技术细节

### 图像处理流程

1. `cap.read()` 读取摄像头帧（可能是BGR或灰度）
2. 检查 `grayscale` 配置和图像维度
3. 如果是灰度图，转换为RGB格式（`cv2.cvtColor(..., cv2.COLOR_GRAY2RGB)`）
4. 后续处理与RGB模式相同

### 代码修改点

- `preprocess_frame()`: 添加 `grayscale` 参数支持
- 主循环: 添加灰度图检测和转换逻辑
- 配置读取: 从配置文件中读取 `grayscale` 参数

## 相关文件

- 配置文件: `src_open/configs/live/cube_ir.yaml`
- 追踪代码: `src_open/tools/live_tracking.py`
- RGB模式配置: `src_open/configs/live/cube_rgb.yaml`
- RGB模式说明: `RGB实时追踪使用说明.md`

